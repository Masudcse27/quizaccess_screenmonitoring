{"version":3,"file":"monitor.min.js","sources":["../src/monitor.js"],"sourcesContent":["define(['jquery'], function ($) {\n    return {\n        init: function (params) {\n            const interval = params.interval || 5000;\n            const quizid = params.quizid;\n            const cmid = params.cmid;\n            const userid = params.userid;\n            const attemptid = params.attemptid;\n            const token = params.token;\n            const uploadurl = params.uploadurl;\n\n            let startButtonClicked = false;\n            let extensionResponded = false;\n\n            function sendStartCapture() {\n                const metadata = {\n                    interval: interval,\n                    quizid: quizid,\n                    cmid: cmid,\n                    userid: userid,\n                    attemptid: attemptid,\n                    uploadurl: uploadurl\n                };\n\n                // Listen for extension reply\n                function waitForExtensionResponse() {\n                    setTimeout(() => {\n                        if (!extensionResponded) {\n                            alert('‚ö†Ô∏è Moodle Screen Capture Extension is not installed or not running.\\n\\nPlease install and enable the extension before starting the quiz.');\n                            startButtonClicked = false;\n                        }\n                    }, 1000); // 1 second timeout\n                }\n\n                extensionResponded = false; // reset\n                window.postMessage({\n                    type: 'FROM_MOODLE',\n                    action: 'startCapture',\n                    interval: interval,\n                    meta: metadata\n                }, '*');\n                waitForExtensionResponse();\n            }\n\n            function sendStopCapture() {\n                window.postMessage({\n                    type: 'FROM_MOODLE',\n                    action: 'stopCapture'\n                }, '*');\n            }\n\n            // Trigger on start button click\n            $(document).on('click', 'form[action*=\"startattempt.php\"] button[type=submit]', function (e) {\n                e.preventDefault();\n                if (!startButtonClicked) {\n                    sendStartCapture();\n                    startButtonClicked = true;\n                }\n            });\n\n            // Listen for extension response\n            window.addEventListener('message', function (event) {\n                if (event.source !== window || !event.data || event.data.type !== 'FROM_EXTENSION') return;\n\n                const msg = event.data;\n\n                if (msg.status === 'extensionPresent') {\n                    extensionResponded = true; // ‚úÖ Extension responded early\n                    console.log('üß© Extension confirmed installed');\n                }\n\n                if (msg.status === 'captureStarted') {\n                    extensionResponded = true;\n                    const form = $('form[action*=\"startattempt.php\"]')[0];\n                    if (form) form.submit();\n                }\n\n                if (msg.status === 'captureFailed') {\n                    extensionResponded = true;\n                    alert('‚ùå Screen sharing was cancelled or failed. You are being redirected to the quiz page.');\n\n                    const cmid = params.cmid;\n                    if (cmid) {\n                        window.location.href = M.cfg.wwwroot + '/mod/quiz/view.php?id=' + cmid;\n                    } else {\n                        window.location.href = M.cfg.wwwroot + '/mod/quiz/';\n                    }\n                }\n            });\n\n            $(document).on('click', 'button[type=submit]', function () {\n                const text = this.textContent.trim().toLowerCase();\n                if (text.includes('submit all and finish') || text.includes('finish attempt') || text.includes('submit quiz')) {\n                    sendStopCapture();\n                }\n            });\n        }\n    };\n});\n"],"names":["define","$","init","params","interval","quizid","cmid","userid","attemptid","uploadurl","token","startButtonClicked","extensionResponded","document","on","e","preventDefault","metadata","window","postMessage","type","action","meta","setTimeout","alert","sendStartCapture","addEventListener","event","source","data","msg","status","console","log","form","submit","location","href","M","cfg","wwwroot","text","this","textContent","trim","toLowerCase","includes"],"mappings":"AAAAA,6CAAO,CAAC,WAAW,SAAUC,SAClB,CACHC,KAAM,SAAUC,cACNC,SAAWD,OAAOC,UAAY,IAC9BC,OAASF,OAAOE,OAChBC,KAAOH,OAAOG,KACdC,OAASJ,OAAOI,OAChBC,UAAYL,OAAOK,UAEnBC,WADQN,OAAOO,MACHP,OAAOM,eAErBE,oBAAqB,EACrBC,oBAAqB,EAwCzBX,EAAEY,UAAUC,GAAG,QAAS,wDAAwD,SAAUC,GACtFA,EAAEC,iBACGL,uCAvCCM,SAAW,CACbb,SAAUA,SACVC,OAAQA,OACRC,KAAMA,KACNC,OAAQA,OACRC,UAAWA,UACXC,UAAWA,WAafG,oBAAqB,EACrBM,OAAOC,YAAY,CACfC,KAAM,cACNC,OAAQ,eACRjB,SAAUA,SACVkB,KAAML,UACP,KAdCM,YAAW,KACFX,qBACDY,MAAM,4IACNb,oBAAqB,KAE1B,KAwBHc,GACAd,oBAAqB,MAK7BO,OAAOQ,iBAAiB,WAAW,SAAUC,UACrCA,MAAMC,SAAWV,SAAWS,MAAME,MAA4B,mBAApBF,MAAME,KAAKT,KAA2B,aAE9EU,IAAMH,MAAME,QAEC,qBAAfC,IAAIC,SACJnB,oBAAqB,EACrBoB,QAAQC,IAAI,qCAGG,mBAAfH,IAAIC,OAA6B,CACjCnB,oBAAqB,QACfsB,KAAOjC,EAAE,oCAAoC,GAC/CiC,MAAMA,KAAKC,YAGA,kBAAfL,IAAIC,OAA4B,CAChCnB,oBAAqB,EACrBY,MAAM,8FAEAlB,KAAOH,OAAOG,KAEhBY,OAAOkB,SAASC,KADhB/B,KACuBgC,EAAEC,IAAIC,QAAU,yBAA2BlC,KAE3CgC,EAAEC,IAAIC,QAAU,iBAKnDvC,EAAEY,UAAUC,GAAG,QAAS,uBAAuB,iBACrC2B,KAAOC,KAAKC,YAAYC,OAAOC,eACjCJ,KAAKK,SAAS,0BAA4BL,KAAKK,SAAS,mBAAqBL,KAAKK,SAAS,iBA/C/F5B,OAAOC,YAAY,CACfC,KAAM,cACNC,OAAQ,eACT"}