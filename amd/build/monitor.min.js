define("quizaccess_screenmonitoring/monitor",["jquery"],(function($){return{init:function(params){const interval=params.interval||5e3,quizid=params.quizid,cmid=params.cmid,userid=params.userid,attemptid=params.attemptid,uploadurl=(params.token,params.uploadurl);let startButtonClicked=!1,extensionResponded=!1;if($(document).on("click",'form[action*="startattempt.php"] button[type=submit]',(function(e){e.preventDefault(),startButtonClicked||(!function(){const metadata={interval:interval,quizid:quizid,cmid:cmid,userid:userid,attemptid:attemptid,uploadurl:uploadurl};extensionResponded=!1,window.postMessage({type:"FROM_MOODLE",action:"startCapture",interval:interval,meta:metadata},"*"),setTimeout((()=>{extensionResponded||(alert("‚ö†Ô∏è Moodle Screen Capture Extension is not installed or not running.\n\nPlease install and enable the extension before starting the quiz."),startButtonClicked=!1)}),1e3)}(),startButtonClicked=!0)})),window.addEventListener("message",(function(event){if(event.source!==window||!event.data||"FROM_EXTENSION"!==event.data.type)return;const msg=event.data;if("extensionPresent"===msg.status&&(extensionResponded=!0,console.log("üß© Extension confirmed installed")),"captureStarted"===msg.status||"already_open"===msg.status){extensionResponded=!0;const form=$('form[action*="startattempt.php"]')[0];form&&form.submit()}if("captureFailed"===msg.status){extensionResponded=!0,alert("‚ùå Screen sharing was cancelled or failed. You are being redirected to the quiz page.");const cmid=params.cmid;window.location.href=cmid?M.cfg.wwwroot+"/mod/quiz/view.php?id="+cmid:M.cfg.wwwroot+"/mod/quiz/"}})),$(document).on("click","button[type=submit]",(function(){const text=this.textContent.trim().toLowerCase();(text.includes("submit all and finish")||text.includes("finish attempt")||text.includes("submit quiz"))&&window.postMessage({type:"FROM_MOODLE",action:"stopCapture"},"*")})),window.location.pathname.includes("attempt.php")){console.log("üìå This is attempt page"),new Promise((resolve=>{let responded=!1;function onMessage(event){event.source===window&&event.data&&"FROM_EXTENSION"===event.data.type&&"popupStatus"===event.data.status&&(window.removeEventListener("message",onMessage),responded=!0,resolve(event.data.popupOpen))}window.addEventListener("message",onMessage),window.postMessage({type:"FROM_MOODLE",action:"pingPopup"},"*"),setTimeout((()=>{responded||(window.removeEventListener("message",onMessage),resolve(!1))}),1e3)})).then((isOpen=>{if(console.log("üì° Extension popup open?",isOpen),!isOpen){console.warn("‚ö†Ô∏è Extension popup is NOT open."),alert("‚ö†Ô∏è You must enable screen sharing to attempt this quiz.\n\nRedirecting to quiz page.");const cmid=params.cmid;window.location.href=cmid?M.cfg.wwwroot+"/mod/quiz/view.php?id="+cmid:M.cfg.wwwroot+"/mod/quiz/"}}))}}}}));

//# sourceMappingURL=monitor.min.js.map